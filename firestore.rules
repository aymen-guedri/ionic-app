rules_version = '2';\nservice cloud.firestore {\n  match /databases/{database}/documents {\n    \n    // Helper functions\n    function isAuthenticated() {\n      return request.auth != null;\n    }\n    \n    function isOwner(userId) {\n      return request.auth.uid == userId;\n    }\n    \n    function isAdmin() {\n      return isAuthenticated() && \n             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&\n             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';\n    }\n    \n    function isValidUser(userData) {\n      return userData.keys().hasAll(['name', 'email', 'role', 'loyaltyPoints', 'tier', 'createdAt', 'preferences']) &&\n             userData.role in ['user', 'admin'] &&\n             userData.tier in ['bronze', 'silver', 'gold', 'platinum'] &&\n             userData.loyaltyPoints is number &&\n             userData.loyaltyPoints >= 0;\n    }\n    \n    function isValidReservation(reservationData) {\n      return reservationData.keys().hasAll(['userId', 'userName', 'spotId', 'spotNumber', 'startTime', 'endTime', 'duration', 'totalCost', 'status', 'paymentStatus', 'createdAt']) &&\n             reservationData.status in ['pending', 'approved', 'active', 'completed', 'cancelled', 'expired'] &&\n             reservationData.paymentStatus in ['pending', 'paid', 'refunded'] &&\n             reservationData.duration is number &&\n             reservationData.duration > 0 &&\n             reservationData.totalCost is number &&\n             reservationData.totalCost >= 0;\n    }\n    \n    function isValidSpot(spotData) {\n      return spotData.keys().hasAll(['number', 'zone', 'type', 'size', 'accessible', 'coordinates', 'status', 'pricePerHour', 'features']) &&\n             spotData.type in ['covered', 'outdoor'] &&\n             spotData.size in ['standard', 'large', 'compact'] &&\n             spotData.status in ['available', 'reserved', 'occupied', 'maintenance'] &&\n             spotData.accessible is bool &&\n             spotData.pricePerHour is number &&\n             spotData.pricePerHour > 0;\n    }\n    \n    // Users collection\n    match /users/{userId} {\n      // Users can read their own data, admins can read all\n      allow read: if isOwner(userId) || isAdmin();\n      \n      // Users can create their own account during registration\n      allow create: if isOwner(userId) && isValidUser(resource.data);\n      \n      // Users can update their own profile (except role and loyaltyPoints)\n      // Admins can update any user\n      allow update: if (isOwner(userId) && \n                       !('role' in request.resource.data.diff(resource.data).affectedKeys()) &&\n                       !('loyaltyPoints' in request.resource.data.diff(resource.data).affectedKeys())) ||\n                       isAdmin();\n      \n      // Only admins can delete users\n      allow delete: if isAdmin();\n    }\n    \n    // Parking spots collection\n    match /parkingSpots/{spotId} {\n      // Everyone can read parking spots\n      allow read: if true;\n      \n      // Only admins can create, update, or delete spots\n      allow create: if isAdmin() && isValidSpot(resource.data);\n      allow update: if isAdmin();\n      allow delete: if isAdmin();\n    }\n    \n    // Reservations collection\n    match /reservations/{reservationId} {\n      // Users can read their own reservations, admins can read all\n      allow read: if isAuthenticated() && \n                     (resource.data.userId == request.auth.uid || isAdmin());\n      \n      // Users can create reservations for themselves\n      allow create: if isAuthenticated() && \n                       resource.data.userId == request.auth.uid &&\n                       isValidReservation(resource.data);\n      \n      // Users can cancel their own pending reservations\n      // Admins can update any reservation\n      allow update: if isAuthenticated() && \n                       ((resource.data.userId == request.auth.uid && \n                         resource.data.status == 'pending' &&\n                         request.resource.data.status == 'cancelled') ||\n                        isAdmin());\n      \n      // Only admins can delete reservations\n      allow delete: if isAdmin();\n    }\n    \n    // Payments collection\n    match /payments/{paymentId} {\n      // Users can read their own payments, admins can read all\n      allow read: if isAuthenticated() && \n                     (resource.data.userId == request.auth.uid || isAdmin());\n      \n      // Only the system (via Cloud Functions) or admins can create payments\n      allow create: if isAdmin();\n      \n      // Only admins can update payments\n      allow update: if isAdmin();\n      \n      // Only admins can delete payments\n      allow delete: if isAdmin();\n    }\n    \n    // Notifications collection\n    match /notifications/{notificationId} {\n      // Users can read their own notifications, admins can read all\n      allow read: if isAuthenticated() && \n                     (resource.data.userId == request.auth.uid || isAdmin());\n      \n      // Only the system (via Cloud Functions) or admins can create notifications\n      allow create: if isAdmin();\n      \n      // Users can mark their own notifications as read\n      // Admins can update any notification\n      allow update: if isAuthenticated() && \n                       ((resource.data.userId == request.auth.uid && \n                         request.resource.data.diff(resource.data).affectedKeys().hasOnly(['read', 'readAt'])) ||\n                        isAdmin());\n      \n      // Users can delete their own notifications, admins can delete any\n      allow delete: if isAuthenticated() && \n                       (resource.data.userId == request.auth.uid || isAdmin());\n    }\n    \n    // Analytics collection (admin only)\n    match /analytics/{analyticsId} {\n      allow read, write: if isAdmin();\n    }\n    \n    // Parking zones collection\n    match /parkingZones/{zoneId} {\n      // Everyone can read parking zones\n      allow read: if true;\n      \n      // Only admins can create, update, or delete zones\n      allow create, update, delete: if isAdmin();\n    }\n    \n    // System settings collection (admin only)\n    match /settings/{settingId} {\n      allow read, write: if isAdmin();\n    }\n    \n    // Promotions collection\n    match /promotions/{promotionId} {\n      // Everyone can read active promotions\n      allow read: if true;\n      \n      // Only admins can manage promotions\n      allow create, update, delete: if isAdmin();\n    }\n    \n    // User sessions for tracking (optional)\n    match /sessions/{sessionId} {\n      // Users can read/write their own sessions\n      allow read, write: if isAuthenticated() && \n                            resource.data.userId == request.auth.uid;\n      \n      // Admins can read all sessions\n      allow read: if isAdmin();\n    }\n    \n    // Feedback collection\n    match /feedback/{feedbackId} {\n      // Users can create feedback\n      allow create: if isAuthenticated() && \n                       resource.data.userId == request.auth.uid;\n      \n      // Users can read their own feedback, admins can read all\n      allow read: if isAuthenticated() && \n                     (resource.data.userId == request.auth.uid || isAdmin());\n      \n      // Only admins can update or delete feedback\n      allow update, delete: if isAdmin();\n    }\n    \n    // Reports collection (admin only)\n    match /reports/{reportId} {\n      allow read, write: if isAdmin();\n    }\n    \n    // Audit logs (admin only, system writes)\n    match /auditLogs/{logId} {\n      allow read: if isAdmin();\n      // Only system can write audit logs\n    }\n    \n    // Default deny rule for any other collections\n    match /{document=**} {\n      allow read, write: if false;\n    }\n  }\n}